- content_for(:title, "Running Insights - Running Experts")
- content_for :head do
  = stylesheet_link_tag 'insights', 'data-turbo-track': 'reload'

%h1 Running Insights
%p Discover patterns in your running data

.insights-grid
  .insight-card
    %h3 📅 Best Day of the Week
    - if @best_day_of_week.any?
      - fastest_day = @best_day_of_week.min_by { |day, data| data[:pace] }
      %p
        %strong= fastest_day[0]
        is your fastest day with
        %strong= "#{format_pace(fastest_day[1][:pace])} /km"

      %ul
        - Date::DAYNAMES.each do |day|
          - if @best_day_of_week[day]
            - data = @best_day_of_week[day]
            %li
              - if day == fastest_day[0]
                %strong #{day}: #{format_pace(data[:pace])} /km - #{data[:count]} runs (#{data[:percentage].round(1)}%)
              - else
                #{day}: #{format_pace(data[:pace])} /km - #{data[:count]} runs (#{data[:percentage].round(1)}%)
              = link_to "Show", activities_path(day_of_week: day.downcase), style: "margin-left: 10px;"
    - else
      %p Not enough data

  .insight-card
    %h3 🕐 Best Time of Day
    - if @best_time_of_day.any?
      - fastest_time = @best_time_of_day.min_by { |window, data| data[:pace] }
      %p
        %strong= fastest_time[0]
        is your fastest time with
        %strong= "#{format_pace(fastest_time[1][:pace])} /km"

      %ul
        - ["00:00-04:00", "04:00-08:00", "08:00-12:00", "12:00-16:00", "16:00-20:00", "20:00-24:00"].each do |window|
          - if @best_time_of_day[window]
            - data = @best_time_of_day[window]
            %li
              - if window == fastest_time[0]
                %strong #{window}: #{format_pace(data[:pace])} /km - #{data[:count]} runs (#{data[:percentage].round(1)}%)
              - else
                #{window}: #{format_pace(data[:pace])} /km - #{data[:count]} runs (#{data[:percentage].round(1)}%)
              = link_to "Show", activities_path(time_window: window), style: "margin-left: 10px;"
    - else
      %p Not enough data

  .insight-card
    %h3 📊 Weekend vs Weekday
    - if @weekend_vs_weekday[:weekend][:pace] && @weekend_vs_weekday[:weekday][:pace]
      - weekend_data = @weekend_vs_weekday[:weekend]
      - weekday_data = @weekend_vs_weekday[:weekday]
      - diff = weekend_data[:pace] - weekday_data[:pace]

      %p
        %strong Weekend:
        #{format_pace(weekend_data[:pace])} /km - #{weekend_data[:count]} runs (#{weekend_data[:percentage].round(1)}%)
        = link_to "Show", activities_path(weekend: true), style: "margin-left: 10px;"
      %p
        %strong Weekday:
        #{format_pace(weekday_data[:pace])} /km - #{weekday_data[:count]} runs (#{weekday_data[:percentage].round(1)}%)
        = link_to "Show", activities_path(weekday: true), style: "margin-left: 10px;"
      %p
        - if diff > 0
          You run #{format_pace(diff.abs)} /km faster on weekdays! 💼
        - elsif diff < 0
          You run #{format_pace(diff.abs)} /km faster on weekends! 🏖️
        - else
          No difference between weekend and weekday pace!
    - else
      %p Not enough data

  .insight-card
    %h3 📈 Monthly Trends
    - if @monthly_trends.any?
      - best_month = @monthly_trends.min_by { |month, data| data[:pace] }
      - most_active_month = @monthly_trends.max_by { |month, data| data[:count] }

      %p
        %strong Best pace:
        #{best_month[0]} with #{format_pace(best_month[1][:pace])} /km
      %p
        %strong Most active:
        #{most_active_month[0]} with #{most_active_month[1][:count]} runs

      %h4 Monthly Breakdown:
      %ul
        - @monthly_trends.each do |month, data|
          %li
            - if month == best_month[0]
              %strong #{month}: #{format_pace(data[:pace])} /km - #{data[:count]} runs - #{data[:distance]}km
            - else
              #{month}: #{format_pace(data[:pace])} /km - #{data[:count]} runs - #{data[:distance]}km
            = link_to "Show", activities_path(month: month), style: "margin-left: 10px;"
    - else
      %p Not enough data

  .insight-card
    %h3 😴 Rest Day Impact
    %p= @rest_day_impact

  .insight-card
    %h3 📏 Distance vs Pace Analysis
    - if @pace_consistency.is_a?(Hash) && @pace_consistency[:average_pace_change_per_km]
      %p
        On average, pace changes by
        %strong= "#{format_pace(@pace_consistency[:average_pace_change_per_km].abs)} /km"
        per kilometer of distance

      - if @pace_consistency[:splits_data].any?
        %h4 Average Pace by Distance:
        %ul
          - @pace_consistency[:splits_data].each do |km, pace|
            %li KM #{km}: #{format_pace(pace)} /km
    - else
      %p= @pace_consistency

  .insight-card
    %h3 🎯 Within-Run Pace Consistency
    - if @within_run_pace_consistency.is_a?(Hash)
      %p
        %strong= @within_run_pace_consistency[:interpretation]
      %p
        Average pace change per km:
        %strong= "#{format_pace(@within_run_pace_consistency[:average_pace_trend_per_km].abs)} /km"
        - if @within_run_pace_consistency[:average_pace_trend_per_km] > 0
          (getting slower)
        - else
          (getting faster)
      %p
        %em Analysis based on #{@within_run_pace_consistency[:runs_analyzed]} runs with split data
    - else
      %p= @within_run_pace_consistency