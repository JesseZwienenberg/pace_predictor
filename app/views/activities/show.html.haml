- content_for(:title, "Activity Details - Running Experts")
- content_for :head do
  = stylesheet_link_tag 'show', 'data-turbo-track': 'reload'

%h1= @activity.name

.activity-overview
  .stats-column
    %table.stats-table
      %tbody
        %tr
          %td
            %strong Date:
          %td= @activity.start_date.strftime("%B %d, %Y")
        %tr
          %td
            %strong Start time:
          %td= @activity.start_date.strftime("%H:%M")
        %tr
          %td
            %strong End time:
          %td= (@activity.start_date + @activity.elapsed_time.seconds).strftime("%H:%M")
        %tr
          %td
            %strong Distance:
          %td= "#{@activity.distance_km.round(2)} km"
        %tr
          %td
            %strong Duration:
          %td= format_time(@activity.duration)
        %tr
          %td
            %strong Pace:
          %td= format_pace(@activity.pace_per_km)
        %tr
          %td
            %strong Elevation:
          %td= @activity.elevation_gain ? "#{@activity.elevation_gain.round(0)}m" : "-"
        %tr
          %td
            %strong Heart Rate:
          %td= @activity.average_heartrate ? "#{@activity.average_heartrate} bpm" : "-"

  .speed-column
    - if !@activity.speed_stream
      - if session[:strava_access_token]
        = button_to "Download Speed Data", activities_import_speed_data_path(@activity), method: :post, class: "btn btn-primary"
      - else
        = link_to "Connect with Strava", strava_login_path, class: "btn", data: { turbo: false }
    - else
      %div.chart-container
        %canvas#speedChart

-# Splits
- if @split_data
  %h2 Kilometer Splits
  %table.splits-table
    %thead
      %tr
        %th KM
        %th Pace (min/km)
        %th Difference
        %th Pace (km/h)
        %th Elevation Change
    %tbody
      - @split_data.each do |split_info|
        %tr
          %td= split_info[:km_label]
          %td= split_info[:formatted_pace]
          %td{style: "color: #{split_info[:difference_data][:color]}"}
            = split_info[:difference_data][:text]
          %td= "#{split_info[:speed_kmph]} km/h"
          %td= split_info[:elevation_text]

-# Best efforts
- if @activity.best_efforts.any?
  %h2 Best Efforts
  %table.efforts-table
    %thead
      %tr
        %th Distance
        %th Time
        %th Pace (min/km)
        %th Pace (km/h)
    %tbody
      - @activity.best_efforts.each do |effort|
        - pace = effort.distance > 0 ? (effort.elapsed_time / 60.0) / (effort.distance / 1000.0) : 0
        %tr
          %td= effort.name
          %td= format_time(effort.elapsed_time)
          %td= format_pace(pace)
          %td= pace_to_kmph(pace)

.actions
  = link_to "‚Üê Back to Activities", activities_path, class: "btn"

- if @activity.speed_stream
  :ruby
    speed_chart_datasets = [
      {
        label: 'Pace',
        data: @speed_chart_datasets[0][:data], # x values should be in seconds
        color: '#09954f',
        showPoints: false,
        borderWidth: 3
      }
    ]
    x_axis_config = {
      type: 'time',
      label: 'Time',
      unit: 'time'
    }
  = render 'shared/pace_chart_script', chart_id: 'speedChart', chart_title: 'Speed Over Time', datasets: speed_chart_datasets, x_axis_config: x_axis_config