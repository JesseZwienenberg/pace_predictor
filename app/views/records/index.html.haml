- content_for(:title, "Personal Records - Running Experts")
- content_for :head do
  = stylesheet_link_tag 'records', 'data-turbo-track': 'reload'

%h1 Personal Records

%div.chart-controls
  %label Exponent:
  %div.exponent-controls
    %button#decrease-exponent.exponent-btn âˆ’
    %input#riegel-exponent{type: "text", value: "#{'%.2f' % @exponent}", readonly: true}
    %button#increase-exponent.exponent-btn +
  %span.exponent-hint
    (For the Riegel formula the default exponent is 1.06)

%div.chart-container{style: "width: 80%; margin: 20px auto;"}
  %canvas#recordsChart

%table.records-table
  %thead
    %tr
      %th Distance
      %th Time
      %th Pace (min/km)
      %th Pace (km/h)
      %th Date
      %th Activity
  %tbody
    - @personal_records.each do |distance_name, record|
      %tr
        %td= distance_name
        %td= format_time(record[:time])
        %td= format_pace(record[:pace])
        %td= "#{grey_decimals(pace_to_kmph(record[:pace]))}"
        %td= record[:date].strftime("%d/%m/%Y")
        %td= link_to record[:activity].name, activity_path(record[:activity])

:ruby
  chart_datasets = [
    {
      label: 'Personal Best Pace',
      data: @chart_data,
      color: '#09954f',
      showPoints: true,
      pointRadius: 6
    },
    {
      label: 'Best Riegel Pace',
      data: @best_riegel_data,
      color: 'lightgrey',
      showPoints: false,
      borderWidth: 3
    },
    {
      label: 'Average Riegel Pace',
      data: @avg_riegel_data,
      color: 'lightgrey',
      showPoints: false,
      borderWidth: 3
    },
    {
      label: 'Worst Riegel Pace',
      data: @worst_riegel_data,
      color: 'lightgrey',
      showPoints: false,
      borderWidth: 3
    }
  ]

= render 'shared/pace_chart_script', chart_id: 'recordsChart', chart_title: 'Personal Best Pace by Distance', datasets: chart_datasets

:javascript
  document.addEventListener('DOMContentLoaded', function() {
    const exponentInput = document.getElementById('riegel-exponent');
    const decreaseBtn = document.getElementById('decrease-exponent');
    const increaseBtn = document.getElementById('increase-exponent');
    const chartName = 'recordsChart';

    // Helper function to convert pace to speed
    function paceToSpeed(pace) {
      return 60 / pace;
    }

    function isChartInPaceMode() {
      const chart = Chart.getChart(chartName);
      if (chart) {
        // Check the y-axis title or check the first data point
        // If y values are typically > 10, it's likely speed (km/h)
        // If y values are typically < 10, it's likely pace (min/km)
        const firstDataPoint = chart.data.datasets[0].data[0];
        if (firstDataPoint && firstDataPoint.y) {
          return firstDataPoint.y < 10; // Pace values are usually < 10, speed values > 10
        }
      }
      return true; // default to pace mode
    }

    function updateChart(exponent) {
      // Update the input field
      exponentInput.value = exponent.toFixed(2);

      // Update button states
      decreaseBtn.disabled = exponent <= 1.03;
      increaseBtn.disabled = exponent >= 1.15;

      // Make AJAX request to get new Riegel data
      fetch(`#{request.path}?exponent=${exponent}`, {
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        // Update the chart with new data
        const chart = Chart.getChart(chartName);
        if (chart) {
          // Update only the Riegel lines (indices 1, 2, 3)
          let processedBest, processedAvg, processedWorst;

          if (!isChartInPaceMode()) {
            // Convert to speed
            processedBest = data.best_riegel_data.map(point => ({
              x: point.x,
              y: paceToSpeed(point.y),
              label: point.label,
              originalPace: point.y
            }));
            processedAvg = data.avg_riegel_data.map(point => ({
              x: point.x,
              y: paceToSpeed(point.y),
              label: point.label,
              originalPace: point.y
            }));
            processedWorst = data.worst_riegel_data.map(point => ({
              x: point.x,
              y: paceToSpeed(point.y),
              label: point.label,
              originalPace: point.y
            }));
          } else {
            // Keep as pace but ensure originalPace property exists
            processedBest = data.best_riegel_data.map(point => ({
              x: point.x,
              y: point.y,
              label: point.label,
              originalPace: point.y
            }));
            processedAvg = data.avg_riegel_data.map(point => ({
              x: point.x,
              y: point.y,
              label: point.label,
              originalPace: point.y
            }));
            processedWorst = data.worst_riegel_data.map(point => ({
              x: point.x,
              y: point.y,
              label: point.label,
              originalPace: point.y
            }));
          }
          chart.data.datasets[1].data = processedBest;
          chart.data.datasets[2].data = processedAvg;
          chart.data.datasets[3].data = processedWorst;
          chart.update();
        }
      })
      .catch(error => {
        console.error('Error updating chart:', error);
      });
    }

    decreaseBtn.addEventListener('click', function() {
      const currentValue = parseFloat(exponentInput.value);
      if (currentValue > 1.03) {
        const newValue = Math.max(1.03, currentValue - 0.01);
        updateChart(newValue);
      }
    });

    increaseBtn.addEventListener('click', function() {
      const currentValue = parseFloat(exponentInput.value);
      if (currentValue < 1.15) {
        const newValue = Math.min(1.15, currentValue + 0.01);
        updateChart(newValue);
      }
    });

    // Set initial button states
    const initialValue = parseFloat(exponentInput.value);
    decreaseBtn.disabled = initialValue <= 1.03;
    increaseBtn.disabled = initialValue >= 1.15;
  });